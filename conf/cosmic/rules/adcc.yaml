version: 1
meta:
  system: adcc
  env: prod
  owner: middleware-team
  tags: [zookeeper, adcc, coordination-service]
  description: "ADCC ZooKeeper 协调服务巡检: 进程状态、磁盘使用、健康检查、配置参数等"

checks:
  # 1. ZooKeeper 服务进程状态
  - id: adcc-process-status
    name: "ADCC ZooKeeper 服务进程状态"
    type: script
    command: "systemctl is-active adcc"
    expect: "active"
    severity: critical
    remediation: "systemctl start adcc"


  # 2. 数据目录磁盘使用量（仅采集，可选告警）
  - id: adcc-disk-usage
    name: "ADCC 数据目录磁盘使用量"
    type: script
    command: "du -sb ${APUSIC_AILP_DATA_DIR:-${APUSIC_HOME:-/kingdee/cosmic}/common/adcc} | awk '{print int($1/1024/1024)}'"
    parse:
      kind: int
    # 可选：添加阈值，例如 > 100000 MB (100GB)
    thresholds:
      - when: "> 100000"
        severity: warn
        message: "ADCC 数据目录超过 100GB"


  # 3. ZooKeeper 节点健康状态（ruok）
  - id: adcc-ruok-check
    name: "ADCC ZooKeeper 节点四字命令 'ruok' 响应"
    type: script
    command: "echo ruok | nc 127.0.0.1 2181"
    expect: "imok"
    severity: critical
    remediation: "检查 ZooKeeper 是否正常运行，网络是否可达"

  # 5. 配置文件关键参数：tickTime
  - id: adcc-zoo-cfg-ticktime
    name: "ADCC ZooKeeper 配置 tickTime 值"
    type: script
    command: "grep '^tickTime=' ${APUSIC_HOME:-/kingdee/cosmic}/common/adcc/adcc-server-1.0/conf/zoo.cfg | cut -d= -f2"
    parse:
      kind: int
    thresholds:
      - when: "< 2000"
        severity: warn
        message: "tickTime 过小，可能导致频繁心跳"
      - when: "> 5000"
        severity: warn
        message: "tickTime 过大，故障检测延迟高"
  
  # 6. ZooKeeper 四字命令：stat 检查
  - id: adcc-stat-check
    name: "ADCC ZooKeeper 节点四字命令 'stat' 响应"
    type: script
    command: "echo stat | nc 127.0.0.1 2181 | grep -c 'Mode:'"
    parse:
      kind: int
    thresholds:
      - when: "== 0"
        severity: critical
        message: "ZooKeeper stat 命令响应异常"
    remediation: "检查 ZooKeeper 服务状态和网络连接"
  
  # 7. ZooKeeper 连接数检查
  - id: adcc-connections-check
    name: "ADCC ZooKeeper 当前连接数"
    type: script
    command: "echo stat | nc 127.0.0.1 2181 | grep 'Connections:' | awk '{print $2}'"
    parse:
      kind: int
    thresholds:
      - when: "> 1000"
        severity: warn
        message: "ZooKeeper 连接数超过 1000，可能存在连接泄漏"
    remediation: "检查客户端连接情况，优化连接管理"
  
  # 8. ZooKeeper 配置文件其他关键参数检查
  - id: adcc-zoo-cfg-params
    name: "ADCC ZooKeeper 配置文件关键参数"
    type: script
    command: |
      CONFIG="${APUSIC_HOME:-/kingdee/cosmic}/common/adcc/adcc-server-1.0/conf/zoo.cfg"
      if [ -f "$CONFIG" ]; then
        grep -E '^initLimit|^syncLimit|^maxClientCnxns' "$CONFIG" | tr '\n' ';' | sed 's/;$//'
      else
        echo "config_not_found"
      fi
    parse:
      kind: string
    severity: info
  
  # 10. ZooKeeper 日志目录大小检查
  - id: adcc-log-size-check
    name: "ADCC ZooKeeper 日志目录大小"
    type: script
    command: "du -sb ${APUSIC_HOME:-/kingdee/cosmic}/common/adcc/adcc-server-1.0/logs 2>/dev/null | awk '{print int($1/1024/1024)}' || echo 0"
    parse:
      kind: int
    thresholds:
      - when: "> 50000"
        severity: warn
        message: "ZooKeeper 日志目录超过 50GB，建议清理或配置日志轮转"
    remediation: "清理历史日志或配置 logrotate 进行日志轮转"