version: 1
meta:
  system: adcc
  env: prod
  owner: middleware-team
  tags: [zookeeper, adcc, coordination-service]

checks:
  # 1. ZooKeeper 服务进程状态
  - id: adcc-process-status
    name: "ADCC ZooKeeper 服务进程状态"
    type: script
    command: "systemctl is-active adcc"
    expect: "active"
    severity: critical
    remediation: "systemctl start adcc"


  # 2. 数据目录磁盘使用量（仅采集，可选告警）
  - id: adcc-disk-usage
    name: "ADCC 数据目录磁盘使用量"
    type: script
    command: "du -sb ${APUSIC_AILP_DATA_DIR:-${APUSIC_HOME:-/kingdee/cosmic}/common/adcc} | awk '{print int($1/1024/1024)}'"
    parse:
      kind: int
    # 可选：添加阈值，例如 > 100000 MB (100GB)
    thresholds:
      - when: "> 100000"
        severity: warn
        message: "ADCC 数据目录超过 100GB"


  # 3. ZooKeeper 节点健康状态（ruok）
  - id: adcc-ruok-check
    name: "ADCC ZooKeeper 节点四字命令 'ruok' 响应"
    type: script
    command: "echo ruok | nc 127.0.0.1 2181"
    expect: "imok"
    severity: critical
    remediation: "检查 ZooKeeper 是否正常运行，网络是否可达"


  # 4. 自定义服务状态脚本（adccServer.sh status）
  - id: adcc-server-status
    name: "ADCC 自定义状态脚本输出"
    type: script
    command: "${APUSIC_HOME:-/kingdee/cosmic}/common/adcc/adcc-server-1.0/bin/adccServer.sh status"
    # 此项主要用于采集，若脚本有标准成功标识（如 'running'），可加 expect
    # 例如：
    # expect: "running"


  # 5. 配置文件关键参数：tickTime
  - id: adcc-zoo-cfg-ticktime
    name: "ADCC ZooKeeper 配置 tickTime 值"
    type: script
    command: "grep '^tickTime=' ${APUSIC_HOME:-/kingdee/cosmic}/common/adcc/adcc-server-1.0/conf/zoo.cfg | cut -d= -f2"
    parse:
      kind: int
    # 可选：验证合理范围，例如 2000~5000
    # thresholds:
    #   - when: "< 2000"
    #     severity: warn
    #     message: "tickTime 过小，可能导致频繁心跳"
    #   - when: "> 5000"
    #     severity: warn
    #     message: "tickTime 过大，故障检测延迟高"