version: 1
meta:
  system: alb
  env: prod
  owner: web-infra-team
  tags: [nginx, alb, load-balancer, reverse-proxy]

checks:
  # 1. ALB 主进程是否存在（"alb: main process"）
  - id: alb-main-process
    name: "ALB 主进程（alb: main process）是否存在"
    type: script
    command: "ps aux | grep 'alb: main process' | grep -v grep | wc -l"
    parse:
      kind: int
    thresholds:
      - when: "!= 1"
        severity: critical
        message: "ALB 主进程异常（应有且仅有1个）"
    remediation: "检查 ALB 是否启动：systemctl restart alb 或手动启动"


  # 2. ALB 工作进程数量
  - id: alb-worker-process-count
    name: "ALB 当前工作进程（alb: peer process）数量"
    type: script
    command: "ps aux | grep 'alb: peer process' | grep -v grep | wc -l"
    parse:
      kind: int
    # 可采集用于比对配置，但通常动态，故仅采集


  # 3. ALB 配置中 worker_processes 值
  - id: alb-worker-process-config
    name: "ALB 配置文件中的 worker_processes 设置"
    type: script
    command: "grep '^worker_processes' ${APUSIC_HOME:-/kingdee/cosmic}/nginx-appstatic/alb/alb-2.0-light-x86/conf/alb.conf | awk '{print $2}' | tr -d ';'"
    parse:
      kind: string
    # 可用于与实际进程数对比（需 custom 类型），此处仅采集


  # 4. 反向代理监听端口及 HTTP 响应
  - id: alb-reverse-proxy-health
    name: "ALB 反向代理 HTTP 响应检查"
    type: script
    command: |
      PORT=$(grep '^ *listen ' ${APUSIC_HOME:-/kingdee/cosmic}/nginx-appstatic/alb/alb-2.0-light-x86/conf/alb.conf | head -n1 | awk '{print $2}' | tr -d ';')
      if [ -z "$PORT" ]; then
        echo "no_port"
      else
        curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$PORT
      fi
    parse:
      kind: string
    thresholds:
      - when: "== 'no_port'"
        severity: critical
        message: "未在 alb.conf 中找到 listen 指令"
      - when: "!= '200' && != 'no_port'"
        severity: critical
        message: "ALB 返回非 200 响应"
    remediation: "检查 ALB 配置及后端服务状态"


  # 5. 错误日志行数（包含 'error'）
  - id: alb-error-log-count
    name: "ALB error.log 中包含 'error' 的行数"
    type: script
    command: "grep -Ic 'error' ${APUSIC_HOME:-/kingdee/cosmic}/nginx-appstatic/alb/alb-2.0-light-x86/logs/error.log 2>/dev/null || echo 0"
    parse:
      kind: int
    thresholds:
      - when: "> 0"
        severity: warn
        message: "发现错误日志条目"


  # 6. 当前 ALB 连接数（netstat 中含 'alb' 的连接）
  - id: alb-connection-count
    name: "ALB 当前网络连接数"
    type: script
    command: "netstat -antp 2>/dev/null | grep alb | wc -l"
    parse:
      kind: int
    # 可选阈值，例如 > 10000
    # thresholds:
    #   - when: "> 10000"
    #     severity: warn
    #     message: "ALB 连接数过高"


  # 7. 日志目录总大小（KB）
  - id: alb-log-size
    name: "ALB logs 目录总大小"
    type: script
    command: "du -s ${APUSIC_HOME:-/kingdee/cosmic}/nginx-appstatic/alb/alb-2.0-light-x86/logs 2>/dev/null | awk '{print $1}' || echo 0"
    parse:
      kind: int
    thresholds:
      - when: "> 1048576"  # 1048576 KB = 1 GB
        severity: critical
        message: "ALB 日志目录超过 1GB，需轮转或清理"
    remediation: "配置 logrotate 或清理历史日志"


  # 8. 4xx/5xx 错误率
  - id: alb-http-error-rate
    name: "ALB 4xx/5xx 请求错误率（%）"
    type: script
    command: |
      LOG="${APUSIC_HOME:-/kingdee/cosmic}/nginx-appstatic/alb/alb-2.0-light-x86/logs/access.log"
      if [ ! -f "$LOG" ] || [ ! -s "$LOG" ]; then
        echo "0.0000"
      else
        TOTAL=$(wc -l < "$LOG")
        if [ "$TOTAL" -eq 0 ]; then
          echo "0.0000"
        else
          ERRORS=$(grep -E 'HTTP/[0-9]+\.[0-9]+" [45][0-9]{2}' "$LOG" | wc -l)
          echo "scale=4; $ERRORS / $TOTAL * 100" | bc
        fi
      fi
    parse:
      kind: float
    thresholds:
      - when: "> 1.0"
        severity: critical
        message: "4xx/5xx 错误率超过 1%"
    remediation: "检查后端服务健康状态及客户端请求合法性"


  # 【可选】复合健康检查
  - id: alb-overall-health
    name: "ALB 整体健康状态"
    type: compound
    children:
      - alb-main-process
      - alb-reverse-proxy-health
      - alb-http-error-rate
      - alb-license-expiry
    logic: >
      (alb-main-process == 1) &&
      (alb-reverse-proxy-health == '200') &&
      (alb-http-error-rate <= 1.0)
    severity: critical