version: 1
meta:
  system: admq
  env: prod
  owner: apusic
  tags: [admq]

checks:
  # 1. 服务状态
  - id: admq-zk-status
    name: "ADMQ ZooKeeper 服务状态"
    type: script
    command: "systemctl is-active admq-zk"
    expect: "active"
    severity: critical
    remediation: "systemctl start admq-zk"

  - id: admq-broker-status
    name: "ADMQ Broker 服务状态"
    type: script
    command: "systemctl is-active admq-broker"
    expect: "active"
    severity: critical
    remediation: "systemctl start admq-broker"

  - id: admq-storage-status
    name: "ADMQ Storage 服务状态"
    type: script
    command: "systemctl is-active admq-storage"
    expect: "active"
    severity: critical
    remediation: "systemctl start admq-storage"


  # 2. 端口监听检查（5672）
  - id: admq-port-5672
    name: "ADMQ 5672 端口监听状态"
    type: script
    command: "ss -tlnp | grep ':5672 ' | wc -l"
    parse:
      kind: int
    thresholds:
      - when: "== 0"
        severity: critical
        message: "ADMQ 端口 5672 未监听"
    remediation: "检查 admq-broker 是否启动并绑定正确端口"


  # 3. 连接数检查
  - id: admq-connection-count
    name: "ADMQ 当前 ESTABLISHED 连接数"
    type: script
    command: "netstat -ant | grep ':5672 ' | grep ESTABLISHED | wc -l"
    parse:
      kind: int
    thresholds:
      - when: "> 200"
        severity: warn
        message: "连接数超过 200，可能存在异常客户端"


  # 4. 磁盘使用量（目录大小）
  - id: admq-disk-usage
    name: "ADMQ 数据目录磁盘使用量"
    type: script
    command: "du -sb ${APUSIC_ADMQ_DATA_DIR:-${APUSIC_HOME:-/kingdee/cosmic}/common/admq} | awk '{print int($1/1024/1024)}'"
    parse:
      kind: int
    # 可选：添加阈值（如 > 50000 MB = 50GB）
    thresholds:
      - when: "> 50000"
        severity: warn
        message: "ADMQ 数据目录超过 50GB"


  # 5. Broker CPU 使用率
  - id: admq-broker-cpu
    name: "ADMQ Broker CPU 使用率（%）"
    type: script
    command: |
      PID=$(cat ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4/bin/broker.pid 2>/dev/null)
      if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
        top -b -n1 -p "$PID" | tail -n1 | awk '{print $9+0}'
      else
        echo "0"
      fi
    parse:
      kind: float
    thresholds:
      - when: "> 400"
        severity: warn
        message: "Broker CPU 使用率超过 400%"


  # 6. Broker 内存使用率
  - id: admq-broker-mem
    name: "ADMQ Broker 内存使用率（%）"
    type: script
    command: |
      PID=$(cat ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4/bin/broker.pid 2>/dev/null)
      if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
        top -b -n1 -p "$PID" | tail -n1 | awk '{print $10+0}'
      else
        echo "0"
      fi
    parse:
      kind: float
    thresholds:
      - when: "> 40"
        severity: warn
        message: "Broker 内存使用率超过 40%"


  # 7. Topic 数量检查
  - id: admq-topic-count
    name: "ADMQ amqp-data/ierp 下 Topic 数量"
    type: script
    command: "${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4/bin/admqctl admin topics list amqp-data/ierp 2>/dev/null | wc -l"
    parse:
      kind: int
    thresholds:
      - when: "> 2000"
        severity: warn
        message: "Topic 数量超过 2000，可能影响性能"


  # 8. 消息积压队列数（.queue.stats 第4列 >0）
  - id: admq-backlog-queues
    name: "存在消息积压的队列数量"
    type: script
    command: |
      cd ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4
      if [ -f .queue.stats ]; then
        awk -F',' '$4>0' .queue.stats | wc -l
      else
        echo "0"
      fi
    parse:
      kind: int
    thresholds:
      - when: "> 100"
        severity: critical
        message: "超过 100 个队列存在消息积压"


  # 9. 未确认消息队列数（.queue.stats 第5列 >0）
  - id: admq-unack-queues
    name: "存在未确认消息的队列数量"
    type: script
    command: |
      cd ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4
      if [ -f .queue.stats ]; then
        awk -F',' '$5>0' .queue.stats | wc -l
      else
        echo "0"
      fi
    parse:
      kind: int
    thresholds:
      - when: "> 100"
        severity: critical
        message: "超过 100 个队列存在未确认消息"


  # 10. 配置检查：auto topic creation
  - id: admq-auto-topic-creation
    name: "ADMQ 是否禁用自动创建 Topic"
    type: script
    command: "grep '^allowAutoTopicCreation=' ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4/config/broker.conf | cut -d= -f2"
    expect: "false"
    severity: warn
    remediation: "设置 allowAutoTopicCreation=false 以避免意外 Topic 创建"


  # 11. 数据副本策略检查
  - id: admq-replica-policy
    name: "ADMQ 数据副本策略（Ensemble/Write/Ack Quorum）"
    type: script
    command: |
      cd ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4
      e=$(grep '^managedLedgerDefaultEnsembleSize=' config/broker.conf | cut -d= -f2)
      w=$(grep '^managedLedgerDefaultWriteQuorum=' config/broker.conf | cut -d= -f2)
      a=$(grep '^managedLedgerDefaultAckQuorum=' config/broker.conf | cut -d= -f2)
      if [ "${e:-0}" -ge 2 ] && [ "${w:-0}" -ge 2 ] && [ "${a:-0}" -ge 1 ]; then
        echo "ok"
      else
        echo "fail"
      fi
    expect: "ok"
    severity: warn
    message: "副本策略异常，可能导致数据丢失"
    remediation: "设置 ensembleSize>=2, writeQuorum>=2, ackQuorum>=1"

  # 12. 存储同步刷盘检查
  - id: admq-storage-sync
    name: "ADMQ Storage 是否关闭同步刷盘（journalSyncData）"
    type: script
    command: "grep '^journalSyncData=' ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4/config/storage.conf | cut -d= -f2"
    expect: "false"
    severity: warn
    remediation: "设置 journalSyncData=false 以提升写入性能（需确保磁盘可靠）"


  # 13. Broker JVM 内存配置
  - id: admq-broker-jvm-mem
    name: "ADMQ Broker JVM 内存配置是否包含 -Xmx2g"
    type: script
    parse:
      kind: string
    # 无法直接用 expect 做子串匹配，故用 custom 或脚本判断
    # workaround: 输出 yes/no
    command: |
      if grep -q 'ADMQ_MEM.*-Xmx2g' ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4/config/broker_env.sh; then
        echo "ok"
      else
        echo "fail"
      fi
    expect: "ok"
    severity: warn
    remediation: "在 broker_env.sh 中配置 ADMQ_MEM 包含 -Xmx2g"


  # 14. Storage JVM 内存配置
  - id: admq-storage-jvm-mem
    name: "ADMQ Storage JVM 内存配置是否包含 -Xmx2g"
    type: script
    command: |
      if grep -q 'STORAGE_MEM.*-Xmx2g' ${APUSIC_HOME:-/kingdee/cosmic}/common/admq/admq-V2.5.4/config/storage_env.sh; then
        echo "ok"
      else
        echo "fail"
      fi
    expect: "ok"
    severity: warn
    remediation: "在 storage_env.sh 中配置 STORAGE_MEM 包含 -Xmx2g"