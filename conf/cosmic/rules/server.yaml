version: 1
meta:
  system: linux-server
  env: prod
  owner: infra-team
  tags: [os, system, performance, kernel]

checks:
  # 1. 内存使用率
  - id: memory-usage
    name: "系统内存使用率"
    type: script
    command: "free | awk '/Mem:/ {printf \"%.2f\", $3/$2 * 100}'"
    parse:
      kind: float
    thresholds:
      - when: "> 90"
        severity: critical
        message: "内存使用率超过 90%"
      - when: "> 80"
        severity: warn
        message: "内存使用率超过 80%"


  # 2. 磁盘使用率（支持自定义路径）
  - id: disk-usage
    name: "系统磁盘使用率（${APUSIC_DISK_PATH:-/}）"
    type: script
    command: "df -h ${APUSIC_DISK_PATH:-/} | awk 'NR==2 {print $5}' | sed 's/%//'"
    parse:
      kind: int
    thresholds:
      - when: "> 90"
        severity: critical
        message: "磁盘使用率超过 90%"
      - when: "> 80"
        severity: warn
        message: "磁盘使用率超过 80%"


  # 3. 系统负载（1分钟平均）
  - id: system-load
    name: "系统1分钟负载"
    type: script
    command: "uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | tr -d ' '"
    parse:
      kind: float
    thresholds:
      - when: "> 4.0"
        severity: critical
        message: "系统负载过高（>4.0）"
      - when: "> 2.0"
        severity: warn
        message: "系统负载偏高（>2.0）"


  # 4. 磁盘 IO 利用率（%util）
  - id: disk-io-util
    name: "磁盘 IO 利用率（设备: ${APUSIC_DEVICE:-vdb}）"
    type: script
    command: |
      iostat -x 1 2 2>/dev/null | awk -v dev="${APUSIC_DEVICE:-vdb}" '$1 == dev {print $NF}' | tail -n1
    parse:
      kind: float
    thresholds:
      - when: "> 90"
        severity: critical
        message: "磁盘 IO 利用率超过 90%"
      - when: "> 70"
        severity: warn
        message: "磁盘 IO 利用率超过 70%"


  # 5. 文件描述符限制
  - id: fd-limit
    name: "当前用户文件描述符限制（ulimit -n）"
    type: script
    command: "ulimit -n"
    parse:
      kind: int
    thresholds:
      - when: "< 65535"
        severity: warn
        message: "文件描述符限制低于 65535，建议调高"
    remediation: |
      在 /etc/security/limits.conf 中添加：
        * soft nofile 65536
        * hard nofile 65536
      并重启会话或服务


  # 6. 内核参数检查（逐项）
  - id: kernel-ip-local-port-range
    name: "内核参数 net.ipv4.ip_local_port_range"
    type: script
    command: "sysctl -n net.ipv4.ip_local_port_range"
    expect: "1024 65000"
    severity: warn
    remediation: "sysctl -w net.ipv4.ip_local_port_range='1024 65000'"

  - id: kernel-somaxconn
    name: "内核参数 net.core.somaxconn"
    type: script
    command: "sysctl -n net.core.somaxconn"
    expect: "65535"
    severity: warn
    remediation: "sysctl -w net.core.somaxconn=65535"

  - id: kernel-tcp-tw-reuse
    name: "内核参数 net.ipv4.tcp_tw_reuse"
    type: script
    command: "sysctl -n net.ipv4.tcp_tw_reuse"
    expect: "1"
    severity: warn
    remediation: "sysctl -w net.ipv4.tcp_tw_reuse=1"

  - id: kernel-tcp-fin-timeout
    name: "内核参数 net.ipv4.tcp_fin_timeout"
    type: script
    command: "sysctl -n net.ipv4.tcp_fin_timeout"
    expect: "15"
    severity: warn
    remediation: "sysctl -w net.ipv4.tcp_fin_timeout=15"

  - id: kernel-tcp-syncookies
    name: "内核参数 net.ipv4.tcp_syncookies"
    type: script
    command: "sysctl -n net.ipv4.tcp_syncookies"
    expect: "1"
    severity: warn
    remediation: "sysctl -w net.ipv4.tcp_syncookies=1"


  # 【可选】复合健康检查
  - id: server-overall-health
    name: "服务器整体健康状态"
    type: compound
    children:
      - memory-usage
      - disk-usage
      - system-load
      - disk-io-util
      - fd-limit
      - kernel-ip-local-port-range
      - kernel-somaxconn
      - kernel-tcp-tw-reuse
      - kernel-tcp-fin-timeout
      - kernel-tcp-syncookies
    logic: >
      (memory-usage <= 90) &&
      (disk-usage <= 90) &&
      (system-load <= 4.0) &&
      (disk-io-util <= 90) &&
      (fd-limit >= 65535) &&
      kernel-ip-local-port-range &&
      kernel-somaxconn &&
      kernel-tcp-tw-reuse &&
      kernel-tcp-fin-timeout &&
      kernel-tcp-syncookies
    severity: critical