## 🧪 MQTT QoS 级别集成测试用例

> **测试前提**：
> - 使用 MQTT 3.1.1 或 5.0 协议
> - Broker：EMQX（行为符合规范）
> - 每个测试使用独立客户端（clean session = true）
> - 测试网络条件：稳定网络环境，无丢包

---

### ✅ 分类一：基本 QoS 功能验证

| ID | 描述 | 发布 QoS | 订阅 QoS | 预期结果 | 说明 |
|----|------|---------|---------|--------|------|
| QoS-01 | QoS 0：最多一次 | 0 | 0 | ✅ 消息最多接收一次（无确认） | 最小开销，可能丢失 |
| QoS-02 | QoS 1：至少一次 | 1 | 1 | ✅ 消息至少接收一次（有 PUBACK） | 确保送达，可能重复 |
| QoS-03 | QoS 2：正好一次 | 2 | 2 | ✅ 消息恰好接收一次（四步握手） | 最高可靠性，最大开销 |

---

### ✅ 分类二：QoS 降级与升级

| ID | 描述 | 发布 QoS | 订阅 QoS | 预期结果 |
|----|------|---------|---------|--------|
| QoS-04 | 发布 QoS 1，订阅 QoS 0 | 1 | 0 | ✅ 收到 QoS 0 消息 | 按订阅 QoS 降级 |
| QoS-05 | 发布 QoS 0，订阅 QoS 1 | 0 | 1 | ✅ 收到 QoS 0 消息 | 按发布 QoS 传递 |
| QoS-06 | 发布 QoS 2，订阅 QoS 1 | 2 | 1 | ✅ 收到 QoS 1 消息 | 按订阅 QoS 降级 |
| QoS-07 | 发布 QoS 1，订阅 QoS 2 | 1 | 2 | ✅ 收到 QoS 1 消息 | 按发布 QoS 传递 |

---

### ✅ 分类三：QoS 与消息可靠性

| ID | 描述 | 发布 QoS | 订阅 QoS | 测试步骤 | 预期结果 |
|----|------|---------|---------|--------|--------|
| QoS-08 | QoS 0 消息丢失模拟 | 0 | 0 | 1. 发布 100 条 QoS 0 消息<br>2. 模拟 10% 丢包<br>3. 统计接收数量 | ❌ 收到约 90 条消息 |
| QoS-09 | QoS 1 确保送达 | 1 | 1 | 1. 发布 100 条 QoS 1 消息<br>2. 模拟 10% 丢包<br>3. 统计接收数量 | ✅ 收到 100 条消息（可能有重复） |
| QoS-10 | QoS 2 精确一次 | 2 | 2 | 1. 发布 100 条 QoS 2 消息<br>2. 模拟 10% 丢包<br>3. 统计接收数量 | ✅ 精确收到 100 条消息 |

---

### ✅ 分类四：QoS 与特殊场景

| ID | 描述 | 发布 QoS | 订阅 QoS | 测试步骤 | 预期结果 |
|----|------|---------|---------|--------|--------|
| QoS-11 | QoS 1 与保留消息 | 1 | 1 | 1. 发布 QoS 1 + retain=true<br>2. 新客户端订阅 | ✅ 收到保留消息 |
| QoS-12 | QoS 2 与 LWT | 2 | 2 | 1. 客户端 A 设置 LWT QoS 2<br>2. 客户端 A 异常断开<br>3. 客户端 B 订阅 | ✅ 收到 LWT 消息 |
| QoS-13 | 混合 QoS 订阅 | 1 | 0,1,2 | 1. 三个客户端分别以 QoS 0,1,2 订阅同一主题<br>2. 发布 QoS 1 消息 | ✅ 所有客户端收到消息，按各自订阅 QoS 处理 |

---

### ✅ 分类五：QoS 与并发

| ID | 描述 | 发布 QoS | 订阅 QoS | 测试步骤 | 预期结果 |
|----|------|---------|---------|--------|--------|
| QoS-14 | 高并发 QoS 2 消息 | 2 | 2 | 1. 10 个客户端并发发布 QoS 2 消息<br>2. 10 个客户端并发订阅<br>3. 总计 1000 条消息 | ✅ 所有消息精确一次送达 |
| QoS-15 | 频繁发布 QoS 1 消息 | 1 | 1 | 1. 每 1ms 发布一条 QoS 1 消息<br>2. 持续 10s | ✅ 所有消息至少送达一次 |

---

## ✅ 总结：覆盖维度

| 维度 | 是否覆盖 |
|------|--------|
| 基本 QoS 0/1/2 功能 | ✅ |
| QoS 降级与升级规则 | ✅ |
| 不同 QoS 可靠性对比 | ✅ |
| QoS 与保留消息 | ✅ |
| QoS 与 LWT | ✅ |
| 混合 QoS 订阅 | ✅ |
| 高并发 QoS 处理 | ✅ |
| QoS 与消息重复 | ✅ |

---