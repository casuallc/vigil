好的！以下是**全面完善的 MQTT 通配符集成测试用例集**，覆盖了你提出的判断依据，并扩展了边界条件、错误处理、多 QoS 场景、空层级、系统主题隔离等关键维度。所有用例均适用于 EMQX（或其他标准 MQTT Broker）的集成测试。

---

## 🧪 MQTT 通配符匹配与路由集成测试用例（完整版）

> **测试前提**：
> - 使用 MQTT 3.1.1 或 5.0 协议
> - Broker：EMQX（行为符合规范）
> - 每个测试使用独立客户端（clean session = true）
> - 所有发布使用 QoS 0（除非特别说明）

---

### ✅ 分类一：单层通配符 `+` 行为验证

| ID | 描述 | 订阅主题 | 发布主题 | 预期结果 | 说明 |
|----|------|--------|--------|--------|------|
| T1-01 | 基本匹配 | `sensor/+/temp` | `sensor/room1/temp` | ✅ 接收 | 正常三层结构 |
| T1-02 | 多一层不匹配 | `sensor/+/temp` | `sensor/room1/humid/temp` | ❌ 不接收 | `+` 只匹配一层 |
| T1-03 | 少一层不匹配 | `sensor/+/temp` | `sensor/temp` | ❌ 不接收 | 缺少中间层 |
| T1-04 | 开头使用 `+` | `+/status` | `light/status` | ✅ 接收 | 首层可通配 |
| T1-05 | 结尾使用 `+` | `device/monitor/+` | `device/monitor/cpu` | ✅ 接收 | 末层可通配 |
| T1-06 | 空层级不匹配 | `sensor/+/temp` | `sensor//temp` | ❌ 不接收 | `+` 不能匹配空字符串 |
| T1-07 | 多个 `+` | `building/+/room/+/value` | `building/A/room/101/value` | ✅ 接收 | 多个单层通配 |
| T1-08 | 匹配数字 | `log/+/event` | `log/42/event` | ✅ 接收 | 层级内容无限制 |
| T1-09 | 区分大小写 | `Sensor/+/Temp` | `sensor/room1/temp` | ❌ 不接收 | 主题区分大小写 |

---

### ✅ 分类二：多层通配符 `#` 行为验证

| ID | 描述 | 订阅主题 | 发布主题 | 预期结果 | 说明 |
|----|------|--------|--------|--------|------|
| T2-01 | 匹配自身 | `sensor/#` | `sensor` | ✅ 接收 | `#` 可匹配零层 |
| T2-02 | 匹配一级子层 | `sensor/#` | `sensor/a` | ✅ 接收 |  |
| T2-03 | 匹配深层路径 | `sensor/#` | `sensor/a/b/c/d` | ✅ 接收 | 任意深度 |
| T2-04 | 前缀不同不匹配 | `sensor/#` | `sensors/a` | ❌ 不接收 | 字符串前缀必须完全一致 |
| T2-05 | 精确等于也匹配 | `home/living/#` | `home/living` | ✅ 接收 |  |
| T2-06 | 仅 `#` 订阅 | `#` | `any/topic/here` | ✅ 接收 | 全局订阅（除 `$SYS`） |
| T2-07 | `#` 与 `/` 边界 | `a/#` | `abc/x` | ❌ 不接收 | 必须以 `/` 分隔，`a` ≠ `abc` |

> ⚠️ 注意：`a/#` 不匹配 `abc/x`，因为 `a` 是完整第一层，不是前缀模糊匹配。

---

### ✅ 分类三：非法通配符订阅（应被拒绝）

| ID | 描述 | 订阅主题 | 预期 Broker 行为 | 说明 |
|----|------|--------|------------------|------|
| T3-01 | `#` 不在末尾 | `sensor/#/extra` | ❌ SUBACK 失败（Reason Code ≠ 0） | MQTT 规范禁止 |
| T3-02 | `#` 后有字符 | `home/#abc` | ❌ 拒绝订阅 | `#` 必须独占末层 |
| T3-03 | `+` 未占整层 | `sensor+temp` | ❌ 拒绝或不匹配任何消息 | 实际中通常视为普通主题，但**不会通配**；建议视为无效用法 |
| T3-04 | 多个 `#` | `a/#/b/#` | ❌ 拒绝订阅 | `#` 只能出现一次且在末尾 |
| T3-05 | 仅 `+` | `+` | ✅ 允许（匹配任意单层主题） | 合法！如发布 `test` 会被匹配 |
| T3-06 | `+/+` | `+/+` | ✅ 允许 | 匹配所有两层主题，如 `a/b` |

> ✅ 补充说明：
> - `+` 和 `#` 本身作为完整层级是合法的。
> - EMQX 在 MQTT 5.0 下对 T3-01 返回 Reason Code `0x8F`（Topic Filter Invalid）。

---

### ✅ 分类四：系统主题 `$SYS` 隔离验证

| ID | 描述 | 订阅主题 | 发布主题 | 预期结果 |
|----|------|--------|--------|--------|
| T4-01 | `#` 不匹配 `$SYS` | `#` | `$SYS/broker/version` | ❌ 不接收 |
| T4-02 | 显式订阅 `$SYS` | `$SYS/broker/version` | `$SYS/broker/version` | ✅ 接收（若权限允许） |
| T4-03 | `+/+/version` 匹配 `$SYS`？ | `+/+/version` | `$SYS/broker/version` | ❌ 不接收 |

> 📌 根据 [MQTT 3.1.1 规范 §4.7.2](https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718106)：
> > “通配符订阅 **不得** 匹配以 `$` 开头的主题名。”

---

### ✅ 分类五：QoS 与通配符组合验证（可选高级用例）

| ID | 描述 | 订阅 | QoS | 发布 | QoS | 预期 |
|----|------|-----|-----|------|-----|------|
| T5-01 | QoS 1 订阅通配符 | `sensor/+/data` | 1 | `sensor/room1/data` | 0 | ✅ 接收，按订阅 QoS 降级 |
| T5-02 | 通配符订阅保留消息 | `sensor/+/status` | 0 | `sensor/room1/status` (retain=true) | 0 | ✅ 首次订阅即收到保留消息 |

---

### ✅ 分类六：边界与特殊字符

| ID | 描述 | 订阅 | 发布 | 预期 |
|----|------|-----|------|------|
| T6-01 | 含特殊字符层级 | `device/+/status` | `device/user@host/status` | ✅ 接收 |
| T6-02 | 空主题（非法） | — | ``（空字符串） | ❌ 发布应失败（Broker 拒绝） |
| T6-03 | 单字符层级 | `+/+` | `a/b` | ✅ 接收 |

---

## ✅ 总结：覆盖维度

| 维度 | 是否覆盖 |
|------|--------|
| `+` 基本匹配 | ✅ |
| `+` 边界（空、多层、位置） | ✅ |
| `#` 基本匹配（含零层） | ✅ |
| `#` 前缀精确性 | ✅ |
| 非法通配符拒绝 | ✅（含 EMQX SUBACK 验证）|
| `$SYS` 隔离 | ✅ |
| 大小写敏感 | ✅ |
| 特殊字符与数字 | ✅ |
| QoS 与 retain（可选）| ✅ |

---